<!DOCTYPE html>
<html>
<head>
  <title>GraphQL + HTMX Tasks</title>
  <script src="https://unpkg.com/htmx.org@1.9.2"></script>
</head>
<body>
  <h1>Tasks</h1>

  <!-- Add Task Form -->
  <form id="add-task-form"
        hx-post="/query"
        hx-target="#task-list"
        hx-swap="outerHTML"
        onsubmit="event.preventDefault(); this.submit();">

    <input name="title" placeholder="New task" id="title-input" required>
    <button type="submit"
            onclick="sendGraphQLAdd()">Add Task</button>
  </form>

  <!-- Task List -->
  <div id="task-list" hx-get="/query" hx-trigger="load" hx-swap="outerHTML">
    Loading tasks...
  </div>

  <script>
    function sendGraphQLAdd() {
      const title = document.getElementById("title-input").value;

      const query = `
        mutation {
          addTask(title: "${title}") {
            id
            title
            completed
          }
        }
      `;

      fetch("/query", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ query }),
      })
      .then(() => {
        document.getElementById("title-input").value = "";
        htmx.trigger("#task-list", "load");
      });
    }

    function toggleTask(id) {
      const query = `
        mutation {
          toggleTask(id: "${id}") {
            id
            completed
          }
        }
      `;
      fetch("/query", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ query }),
      })
      .then(() => {
        htmx.trigger("#task-list", "load");
      });
    }
  </script>
</body>
</html>
